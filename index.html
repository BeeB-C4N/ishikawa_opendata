<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monthly Embed</title>
  <style>
    html, body {
      margin: 0; padding: 0; background:#fff;
      min-height: 100vh; display:flex; justify-content:center; align-items:flex-start;
      overflow: auto; /* 縦横スクロール可 */
    }
    .wrap { margin: 40px; max-width: 100%; overflow: auto; }
    /* デフォルトは固定サイズ。responsive:true の場合は下で上書き */
    iframe {
      border: 0; display: block; width: 1200px; height: 800px;
      background: #fff;
    }
    .msg { font: 14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:#333; }
    .center { text-align: center; }
  </style>
</head>
<body>
  <div class="wrap" id="container">
    <div class="msg center">読み込み中…</div>
  </div>

  <script>
    // 読み込みキャッシュを避けるためにタイムスタンプを付与
    const CONFIG_URL = './current.json?v=' + Date.now();

    // 埋め込み許可ドメイン（必要に応じて追加）
    const ALLOWLIST = [
      'public.tableau.com',
      'tableau.public.tableau.com',
      // Webアプリも埋め込むならそのドメインを追加
      'your-webapp.example.com',
      // 同一オリジンを許す場合は以下を追加（不要なら消してOK）
      location.hostname
    ];

    function isAllowed(urlStr){
      try {
        const u = new URL(urlStr);
        return ALLOWLIST.some(host => u.hostname === host || u.hostname.endsWith('.' + host));
      } catch(e){ return false; }
    }

    function applyResponsive(iframe, cfg) {
      // responsive: true のときはビューポートにフィット（はみ出す場合はスクロール可）
      iframe.style.width  = 'min(1200px, 100vw - 80px)';
      iframe.style.height = 'min(800px, 100vh - 80px)';
      if (cfg.maxWidth)  iframe.style.maxWidth  = cfg.maxWidth + 'px';
      if (cfg.maxHeight) iframe.style.maxHeight = cfg.maxHeight + 'px';
    }

    fetch(CONFIG_URL, { cache: 'no-store' })
      .then(r => r.json())
      .then(cfg => {
        const container = document.getElementById('container');

        if (!cfg || !cfg.src) {
          container.innerHTML = '<div class="msg">current.json に "src" が設定されていません。</div>';
          return;
        }
        if (!isAllowed(cfg.src)) {
          container.innerHTML = '<div class="msg">許可されていないドメインのURLです：<br><code>' + cfg.src + '</code></div>';
          return;
        }

        const iframe = document.createElement('iframe');
        iframe.src = cfg.src;

        // 固定サイズ（width/height） or レスポンシブ（responsive: true）
        if (cfg.responsive) {
          applyResponsive(iframe, cfg);
          // ウィンドウサイズ変化で再計算
          window.addEventListener('resize', () => applyResponsive(iframe, cfg));
        } else {
          if (Number.isFinite(cfg.width))  iframe.style.width  = cfg.width + 'px';
          if (Number.isFinite(cfg.height)) iframe.style.height = cfg.height + 'px';
        }

        // アクセシビリティ/セキュリティ（必要に応じて）
        // sandboxやallow属性を制御したい場合はここで設定
        // iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-downloads');
        // iframe.setAttribute('allow', 'clipboard-write; fullscreen');

        container.innerHTML = '';
        container.appendChild(iframe);
      })
      .catch(err => {
        document.getElementById('container').innerHTML =
          '<div class="msg">設定の読み込みに失敗しました。</div>';
        console.error(err);
      });
  </script>
</body>
</html>
